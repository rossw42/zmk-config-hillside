#!/bin/bash
# Pre-commit hook for ZMK Config
# Automatically syncs generic keymaps before committing

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ðŸ”„ Pre-commit: Syncing generic keymaps...${NC}"

# Get the root directory of the repo
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

# Check if generic keymap files exist
if [ ! -f "config/generic_3x5.keymap" ]; then
    echo -e "${YELLOW}âš ï¸  No generic keymaps found, skipping sync${NC}"
    exit 0
fi

# Detect OS and set script extensions
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" || "$OSTYPE" == "cygwin" ]]; then
    # Windows - use PowerShell scripts
    SCRIPT_EXT=".ps1"
    SCRIPT_CMD="powershell -ExecutionPolicy Bypass -File"
else
    # Unix-like (Linux, macOS, etc.) - use shell scripts
    SCRIPT_EXT=".sh"
    SCRIPT_CMD=""
fi

# Track if anything changed
CHANGES_MADE=false

# Run sync scripts
echo "  â†’ Syncing 3x5 to 3x6..."
if [ -n "$SCRIPT_CMD" ]; then
    # Windows: run with PowerShell
    if $SCRIPT_CMD "./scripts/sync_3x5_to_3x6${SCRIPT_EXT}" > /dev/null 2>&1; then
        echo -e "    ${GREEN}âœ“${NC} 3x5 â†’ 3x6 synced"
    else
        echo -e "    ${RED}âœ—${NC} Failed to sync 3x5 â†’ 3x6"
        exit 1
    fi
else
    # Unix: run shell script directly
    if ./scripts/sync_3x5_to_3x6${SCRIPT_EXT} > /dev/null 2>&1; then
        echo -e "    ${GREEN}âœ“${NC} 3x5 â†’ 3x6 synced"
    else
        echo -e "    ${RED}âœ—${NC} Failed to sync 3x5 â†’ 3x6"
        exit 1
    fi
fi

echo "  â†’ Syncing to .dtsi files..."
if [ -n "$SCRIPT_CMD" ]; then
    # Windows: run with PowerShell
    if $SCRIPT_CMD "./scripts/sync_all_generic_layers${SCRIPT_EXT}" > /dev/null 2>&1; then
        echo -e "    ${GREEN}âœ“${NC} .dtsi files synced"
    else
        echo -e "    ${RED}âœ—${NC} Failed to sync .dtsi files"
        exit 1
    fi
else
    # Unix: run shell script directly
    if ./scripts/sync_all_generic_layers${SCRIPT_EXT} > /dev/null 2>&1; then
        echo -e "    ${GREEN}âœ“${NC} .dtsi files synced"
    else
        echo -e "    ${RED}âœ—${NC} Failed to sync .dtsi files"
        exit 1
    fi
fi

# Check if any .dtsi or generic_3x6.keymap files changed
if git diff --quiet config/generic_3x5_layers.dtsi config/generic_3x6_layers.dtsi config/generic_3x6.keymap 2>/dev/null; then
    echo -e "${GREEN}âœ“ No changes needed${NC}"
else
    echo -e "${YELLOW}  â†’ Adding synced files to commit${NC}"
    git add config/generic_3x5_layers.dtsi config/generic_3x6_layers.dtsi config/generic_3x6.keymap
    CHANGES_MADE=true
fi

if [ "$CHANGES_MADE" = true ]; then
    echo -e "${GREEN}âœ“ Generic keymaps synced and staged${NC}"
else
    echo -e "${GREEN}âœ“ Generic keymaps already in sync${NC}"
fi

echo ""
exit 0
